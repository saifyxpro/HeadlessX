```mermaid
%%{init: {'theme':'base', 'themeVariables': { 'primaryColor':'#6366f1','primaryTextColor':'#fff','primaryBorderColor':'#4f46e5','lineColor':'#4f46e5','secondaryColor':'#10b981','tertiaryColor':'#f59e0b'}}}%%

flowchart TD
    Start([User Visits HeadlessX]) --> CheckInstall{Check .installed file}
    
    CheckInstall -->|File EXISTS| RedirectDash[Redirect to /dashboard]
    CheckInstall -->|File NOT EXISTS| ShowInstall[Show /install/system-check]
    
    RedirectDash --> End1([User sees Dashboard])
    
    %% Installation Wizard Flow
    ShowInstall --> Step1[Step 1: System Detection]
    
    Step1 --> DetectOS[ğŸ” Auto-detect OS]
    DetectOS --> CheckNode[Check Node.js Version]
    CheckNode --> CheckRAM[Check Available RAM]
    CheckRAM --> CheckDisk[Check Disk Space]
    CheckDisk --> CheckPnpm[Check pnpm Installed]
    
    CheckPnpm --> SystemValid{All Requirements Met?}
    
    SystemValid -->|âŒ NO| ShowErrors[Display Errors & Fix Instructions]
    ShowErrors --> FixManual{User Fixed Issues?}
    FixManual -->|No| ShowErrors
    FixManual -->|Yes| Step1
    
    SystemValid -->|âœ… YES| Step2[Step 2: Configuration]
    
    Step2 --> GenToken[ğŸ” Auto-generate AUTH_TOKEN]
    GenToken --> InputDomain[User inputs Domain/Subdomain]
    InputDomain --> InputPorts[User chooses Ports]
    InputPorts --> SelectFeatures[User selects Features:<br/>AI, Proxy, Monitoring]
    SelectFeatures --> ValidateConfig{Validate Configuration}
    
    ValidateConfig -->|âŒ Invalid| ShowConfigError[Show Validation Errors]
    ShowConfigError --> Step2
    
    ValidateConfig -->|âœ… Valid| SaveEnv[ğŸ’¾ Save to .env file]
    SaveEnv --> Step3[Step 3: Dependencies Installation]
    
    Step3 --> CheckPnpmAgain{pnpm Installed?}
    
    CheckPnpmAgain -->|âŒ NO| InstallPnpm[ğŸ“¦ npm install -g pnpm]
    CheckPnpmAgain -->|âœ… YES| RunPnpmInstall
    InstallPnpm --> PnpmSuccess{Success?}
    
    PnpmSuccess -->|âŒ Failed| ShowPnpmError[âŒ Show Error + Retry Button]
    ShowPnpmError --> RetryPnpm{Retry?}
    RetryPnpm -->|Yes| InstallPnpm
    RetryPnpm -->|No| AbortInstall[Abort Installation]
    
    PnpmSuccess -->|âœ… Success| RunPnpmInstall[pnpm install]
    
    RunPnpmInstall --> WSConnect[ğŸ”Œ Connect WebSocket /ws/install]
    WSConnect --> StreamLogs[ğŸ“ Stream Live Logs to Frontend]
    
    StreamLogs --> InstallPackages[Installing Packages<br/>Progress: 0-100%]
    InstallPackages --> InstallPlaywright[ğŸ­ pnpm exec playwright install]
    InstallPlaywright --> InstallSuccess{Success?}
    
    InstallSuccess -->|âŒ Failed| ShowInstError[âŒ Show Error + Retry]
    ShowInstError --> RetryInstall{Retry?}
    RetryInstall -->|Yes| RunPnpmInstall
    RetryInstall -->|No| AbortInstall
    
    InstallSuccess -->|âœ… Success| Step4[Step 4: Database Setup Optional]
    
    Step4 --> DBChoice{User Choice}
    
    DBChoice -->|Docker Compose| GenDockerCompose[Generate docker-compose.yml]
    GenDockerCompose --> RunDockerCompose[docker-compose up -d]
    RunDockerCompose --> TestDBConnection
    
    DBChoice -->|Existing DB| InputDBStrings[User enters DB connection strings]
    InputDBStrings --> TestDBConnection[ğŸ”— Test DB Connections]
    
    DBChoice -->|Skip| Step5[Step 5: Completion]
    
    TestDBConnection --> DBValid{DB Connection Valid?}
    
    DBValid -->|âŒ Failed| ShowDBError[âŒ Show Connection Error]
    ShowDBError --> RetryDB{Retry?}
    RetryDB -->|Yes| Step4
    RetryDB -->|No| Step5
    
    DBValid -->|âœ… Success| RunMigrations[ğŸ”„ Run Database Migrations]
    RunMigrations --> Step5
    
    Step5 --> CreateMarker[ğŸ“ Create .installed file]
    CreateMarker --> StartServices[ğŸš€ Start Services:<br/>pnpm run dev]
    
    StartServices --> ShowLinks[Display Access Links:<br/>Frontend: localhost:3000<br/>Backend: localhost:5000<br/>Docs: localhost:5000/api/docs]
    
    ShowLinks --> Countdown[â±ï¸ Auto-redirect in 5 seconds]
    Countdown --> RedirectComplete[Redirect to /dashboard]
    
    RedirectComplete --> End2([âœ… Installation Complete])
    AbortInstall --> End3([âŒ Installation Aborted])
    
    %% One-Time Access Protection
    note1[ğŸ”’ ONE-TIME ACCESS:<br/>Once .installed exists,<br/>/install routes redirect<br/>to /dashboard]
    
    %% Middleware Protection
    note2[ğŸ›¡ï¸ BACKEND MIDDLEWARE:<br/>checkInstallation.js<br/>blocks all API routes<br/>until installed]
    
    style Start fill:#6366f1,stroke:#4f46e5,stroke-width:3px,color:#fff
    style End1 fill:#10b981,stroke:#059669,stroke-width:3px,color:#fff
    style End2 fill:#10b981,stroke:#059669,stroke-width:3px,color:#fff
    style End3 fill:#ef4444,stroke:#dc2626,stroke-width:3px,color:#fff
    
    style Step1 fill:#8b5cf6,stroke:#7c3aed,stroke-width:2px,color:#fff
    style Step2 fill:#8b5cf6,stroke:#7c3aed,stroke-width:2px,color:#fff
    style Step3 fill:#8b5cf6,stroke:#7c3aed,stroke-width:2px,color:#fff
    style Step4 fill:#8b5cf6,stroke:#7c3aed,stroke-width:2px,color:#fff
    style Step5 fill:#8b5cf6,stroke:#7c3aed,stroke-width:2px,color:#fff
    
    style CheckInstall fill:#f59e0b,stroke:#d97706,stroke-width:2px
    style SystemValid fill:#f59e0b,stroke:#d97706,stroke-width:2px
    style ValidateConfig fill:#f59e0b,stroke:#d97706,stroke-width:2px
    style CheckPnpmAgain fill:#f59e0b,stroke:#d97706,stroke-width:2px
    style PnpmSuccess fill:#f59e0b,stroke:#d97706,stroke-width:2px
    style InstallSuccess fill:#f59e0b,stroke:#d97706,stroke-width:2px
    style DBValid fill:#f59e0b,stroke:#d97706,stroke-width:2px
    
    style ShowErrors fill:#ef4444,stroke:#dc2626,stroke-width:2px,color:#fff
    style ShowConfigError fill:#ef4444,stroke:#dc2626,stroke-width:2px,color:#fff
    style ShowPnpmError fill:#ef4444,stroke:#dc2626,stroke-width:2px,color:#fff
    style ShowInstError fill:#ef4444,stroke:#dc2626,stroke-width:2px,color:#fff
    style ShowDBError fill:#ef4444,stroke:#dc2626,stroke-width:2px,color:#fff
    
    style CreateMarker fill:#10b981,stroke:#059669,stroke-width:2px,color:#fff
    style StartServices fill:#10b981,stroke:#059669,stroke-width:2px,color:#fff
    
    style note1 fill:#fef3c7,stroke:#f59e0b,stroke-width:2px,color:#000
    style note2 fill:#fef3c7,stroke:#f59e0b,stroke-width:2px,color:#000
```

---

## Installation Wizard Components

### Frontend Pages Flow

```
/install
â”œâ”€â”€ /system-check      â† Step 1: Auto-detect OS, Node, RAM, Disk, pnpm
â”œâ”€â”€ /configuration     â† Step 2: Domain, Port, Token, Features
â”œâ”€â”€ /dependencies      â† Step 3: Install pnpm + packages (WebSocket logs)
â”œâ”€â”€ /database         â† Step 4: Docker Compose or existing DB
â””â”€â”€ /complete         â† Step 5: Success + redirect to dashboard
```

### Backend API Endpoints

```
/api/install
â”œâ”€â”€ GET  /check-status          â†’ { installed: boolean, version: string }
â”œâ”€â”€ GET  /system-info           â†’ OS, Node, RAM, CPU, disk, pnpm status
â”œâ”€â”€ POST /check-pnpm            â†’ Check if pnpm is installed
â”œâ”€â”€ POST /install-pnpm          â†’ Install pnpm globally via npm
â”œâ”€â”€ POST /install-dependencies  â†’ Run pnpm install (with progress)
â”œâ”€â”€ POST /install-playwright    â†’ Install Playwright browsers
â”œâ”€â”€ POST /generate-config       â†’ Create .env file
â”œâ”€â”€ POST /setup-databases       â†’ Run docker-compose or test DB
â”œâ”€â”€ POST /finalize              â†’ Create .installed, start services
â””â”€â”€ WS   /ws/install            â†’ Real-time logs & progress
```

### Protection Logic

**Frontend (client/app/layout.tsx):**
```typescript
// On every page load:
if (!installed && !pathname.startsWith('/install')) {
  router.push('/install/system-check'); // Not installed â†’ force install
}

if (installed && pathname.startsWith('/install')) {
  router.push('/dashboard'); // Already installed â†’ block install page
}
```

**Backend (server/src/middleware/checkInstallation.js):**
```javascript
// Block all API routes except /api/install/* until installed
if (!fs.existsSync('.installed') && !req.path.startsWith('/api/install')) {
  return res.status(503).json({
    error: 'HeadlessX is not installed. Please complete installation first.',
    redirect: '/install/system-check'
  });
}
```

### Key Features

âœ… **One-Time Only** - Installation page only accessible when NOT installed  
âœ… **Auto-Detection** - Detects OS (Windows/Mac/Linux), Node.js, RAM, disk space  
âœ… **pnpm-First** - Auto-installs pnpm if missing, uses it for all installations  
âœ… **No Manual Scripts** - User clicks "Install" in browser, backend runs scripts  
âœ… **Real-Time Progress** - WebSocket streams live logs and progress (0-100%)  
âœ… **Error Recovery** - Retry buttons on failures, detailed error messages  
âœ… **Cross-Platform** - Works on Windows (PowerShell), macOS, Linux (bash)  
âœ… **Security** - CSRF protection, rate limiting, input validation  
âœ… **Post-Install Protection** - Once installed, `/install` routes blocked forever  

### Installation Marker

**File:** `.installed`
```json
{
  "installed": true,
  "installedAt": "2025-10-19T14:30:00.000Z",
  "version": "2.0.0",
  "features": ["core", "ai", "proxy", "monitoring"],
  "config": {
    "backend_port": 5000,
    "frontend_port": 3000,
    "domain": "headlessx.example.com"
  }
}
```

Once this file exists:
- âŒ `/install/*` routes â†’ **Redirect to `/dashboard`**
- âŒ All API routes â†’ **Require authentication**
- âœ… Dashboard accessible
- âœ… Full functionality enabled
